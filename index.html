<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Time Entry Tool - Enhanced UI</title>

  <!-- MSAL -->
  <script src="https://alcdn.msauth.net/browser/2.38.0/js/msal-browser.min.js"></script>

  <style>
    :root {
      /* Modern Color Palette */
      --primary: #3b82f6;
      --primary-hover: #2563eb;
      --primary-light: #dbeafe;
      --secondary: #64748b;
      --secondary-hover: #475569;
      --success: #10b981;
      --success-hover: #059669;
      --warning: #f59e0b;
      --warning-hover: #d97706;
      --danger: #ef4444;
      --danger-hover: #dc2626;
      --danger-light: #fee2e2;
      
      /* Neutrals */
      --gray-50: #f8fafc;
      --gray-100: #f1f5f9;
      --gray-200: #e2e8f0;
      --gray-300: #cbd5e1;
      --gray-400: #94a3b8;
      --gray-500: #64748b;
      --gray-600: #475569;
      --gray-700: #334155;
      --gray-800: #1e293b;
      --gray-900: #0f172a;
      
      /* Typography */
      --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      --font-mono: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, monospace;
      
      /* Shadows */
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      
      /* Border Radius */
      --radius-sm: 0.375rem;
      --radius: 0.5rem;
      --radius-md: 0.75rem;
      --radius-lg: 1rem;
      --radius-xl: 1.5rem;
      
      /* Transitions */
      --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      --transition-fast: all 0.15s ease-out;
    }
    
    /* Import Inter font */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

    * {
      box-sizing: border-box;
    }

    body { 
      font-family: var(--font-sans); 
      background: linear-gradient(135deg, var(--gray-50) 0%, var(--gray-100) 100%);
      margin: 0; 
      padding: 20px; 
      line-height: 1.6;
      color: var(--gray-700);
      min-height: 100vh;
    }

    /* Animations */
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-4px); }
      75% { transform: translateX(4px); }
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes fadeOutDown {
      from {
        opacity: 1;
        transform: translateY(0);
      }
      to {
        opacity: 0;
        transform: translateY(20px);
      }
    }

    @keyframes fadeOutUp {
      from {
        opacity: 1;
        transform: translateY(0);
      }
      to {
        opacity: 0;
        transform: translateY(-20px);
      }
    }

    /* Loading States */
    .spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid transparent;
      border-top: 2px solid currentColor;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 8px;
    }

    .loading {
      opacity: 0.6;
      pointer-events: none;
    }

    /* Section Cards */
    .section {
      background: white;
      padding: 32px;
      max-width: 1400px;
      margin: 0 auto 32px auto;
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-lg);
      border: 1px solid var(--gray-200);
      transition: var(--transition);
    }

    .section:hover {
      box-shadow: var(--shadow-xl);
    }

    /* Typography */
    h1 {
      font-size: 2.5rem;
      font-weight: 700;
      margin: 0 0 8px 0;
      color: var(--gray-900);
    }

    h2 { 
      font-size: 1.875rem; 
      font-weight: 600;
      margin: 0 0 24px 0; 
      color: var(--gray-800);
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .subtitle {
      font-size: 1.125rem;
      color: var(--gray-500);
      margin-bottom: 32px;
    }

    /* Enhanced Button System */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      border: none;
      border-radius: var(--radius-md);
      font-weight: 500;
      font-size: 0.875rem;
      cursor: pointer;
      padding: 12px 20px;
      transition: var(--transition);
      text-decoration: none;
      position: relative;
      overflow: hidden;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-sm {
      padding: 8px 12px;
      font-size: 0.8125rem;
    }

    .btn-lg {
      padding: 16px 24px;
      font-size: 1rem;
    }

    /* Button Variants */
    .btn-primary { 
      background: var(--primary); 
      color: white;
      box-shadow: var(--shadow);
    }
    .btn-primary:hover:not(:disabled) { 
      background: var(--primary-hover); 
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }

    .btn-secondary { 
      background: var(--gray-100); 
      color: var(--gray-700);
      border: 1px solid var(--gray-300);
    }
    .btn-secondary:hover:not(:disabled) { 
      background: var(--gray-200); 
      border-color: var(--gray-400);
    }

    .btn-success { 
      background: var(--success); 
      color: white;
      box-shadow: var(--shadow);
    }
    .btn-success:hover:not(:disabled) { 
      background: var(--success-hover); 
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }

    .btn-danger { 
      background: var(--danger); 
      color: white;
      box-shadow: var(--shadow);
    }
    .btn-danger:hover:not(:disabled) { 
      background: var(--danger-hover); 
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }

    .btn-ghost {
      background: transparent;
      color: var(--gray-600);
      border: 1px solid transparent;
    }
    .btn-ghost:hover:not(:disabled) {
      background: var(--gray-100);
      color: var(--gray-700);
    }

    /* Enhanced Table Styling */
    .table-container {
      background: white;
      border-radius: var(--radius-lg);
      border: 1px solid var(--gray-200);
      overflow: hidden;
      box-shadow: var(--shadow);
    }

    table { 
      width: 100%; 
      border-collapse: collapse; 
      font-size: 0.875rem;
    }

    th, td { 
      padding: 16px 20px; 
      text-align: left; 
      vertical-align: middle;
      border-bottom: 1px solid var(--gray-200);
    }

    th {
      background: var(--gray-50);
      font-weight: 600;
      color: var(--gray-700);
      font-size: 0.8125rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    th.required::after { 
      content: " *"; 
      color: var(--danger); 
      font-weight: 700;
    }

    tbody tr:hover {
      background: var(--gray-50);
    }

    tbody tr:last-child td {
      border-bottom: none;
    }

    /* Hours column sizing */
    th:nth-child(4), td:nth-child(4) {
      width: 95px;
      min-width: 95px;
      max-width: 95px;
    }

    td:nth-child(4) input[type="number"] {
      width: 100%;
      text-align: center;
      padding: 8px 4px;
    }

    /* Enhanced Form Inputs */
    .input-group {
      position: relative;
      margin-bottom: 20px;
    }

    .input-label {
      display: block;
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--gray-700);
      margin-bottom: 8px;
    }

    input, select, textarea { 
      width: 100%; 
      padding: 12px 16px; 
      border: 2px solid var(--gray-200);
      border-radius: var(--radius-md);
      font-size: 0.875rem;
      transition: var(--transition);
      background: white;
      color: var(--gray-700);
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px var(--primary-light);
    }

    input:invalid, select:invalid {
      border-color: var(--danger);
      background: var(--danger-light);
    }

    .invalid-hours { 
      border-color: var(--danger) !important;
      background: var(--danger-light) !important;
      animation: shake 0.3s ease-in-out;
    }



    /* Status Indicators */
    .status-indicator {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 12px;
      border-radius: var(--radius);
      font-size: 0.75rem;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .status-success {
      background: var(--success);
      color: white;
    }

    .status-warning {
      background: var(--warning);
      color: white;
    }

    .status-error {
      background: var(--danger);
      color: white;
    }

    /* Enhanced Group Sections */
    .group-section {
      margin-bottom: 32px;
      border: 1px solid var(--gray-200);
      border-radius: var(--radius-lg);
      overflow: hidden;
      background: white;
    }

    .group-section summary {
      padding: 20px 24px;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-hover) 100%);
      color: white;
      font-weight: 600;
      cursor: pointer;
      user-select: none;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .group-section summary:hover {
      background: linear-gradient(135deg, var(--primary-hover) 0%, var(--primary) 100%);
    }

    .group-section[open] summary {
      border-bottom: 1px solid var(--gray-200);
    }

    .group-weeks {
      padding: 24px;
    }

    .week-header td { 
      background: linear-gradient(135deg, var(--gray-100) 0%, var(--gray-200) 100%);
      font-weight: 600;
      color: var(--gray-700);
      border-top: 2px solid var(--primary);
    }

    .total-row { 
      background: linear-gradient(135deg, var(--primary-light) 0%, var(--primary) 10%);
      font-weight: 600;
      color: var(--primary-hover);
    }

    /* Edit Mode Styling */
    tr.editing { 
      background: linear-gradient(135deg, var(--warning) 0%, rgba(245, 158, 11, 0.1) 100%) !important;
      border: 2px solid var(--warning);
      border-radius: var(--radius-md);
    }

    /* Sign-in Page */
    #signin-container { 
      text-align: center; 
      margin-top: 10vh;
      padding: 48px;
      background: white;
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-xl);
      max-width: 480px;
      margin-left: auto;
      margin-right: auto;
      border: 1px solid var(--gray-200);
    }

    .signin-icon {
      width: 64px;
      height: 64px;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-hover) 100%);
      border-radius: var(--radius-lg);
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 24px;
      color: white;
      font-size: 24px;
    }

    /* Action Controls */
    .actions-toolbar {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 24px;
      padding: 20px;
      background: var(--gray-50);
      border-radius: var(--radius-lg);
      border: 1px solid var(--gray-200);
    }

    .actions-inline {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    /* Utilities */
    .hidden { display: none !important; }

    .empty-state {
      text-align: center;
      padding: 48px 24px;
      color: var(--gray-500);
    }

    .empty-state-icon {
      width: 48px;
      height: 48px;
      margin: 0 auto 16px;
      opacity: 0.5;
    }

    /* Toast Notifications */
    .toast {
      position: fixed;
      top: 24px;
      right: 24px;
      padding: 16px 20px;
      background: white;
      border: 1px solid var(--gray-200);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg);
      max-width: 400px;
      z-index: 1000;
      transform: translateX(100%);
      transition: transform 0.3s ease-out;
    }

    .toast.show {
      transform: translateX(0);
    }

    .toast-success {
      border-left: 4px solid var(--success);
    }

    .toast-error {
      border-left: 4px solid var(--danger);
    }

    .toast-warning {
      border-left: 4px solid var(--warning);
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      body { 
        padding: 12px; 
      }
      
      .section { 
        padding: 20px; 
        margin-bottom: 20px;
      }
      
      h1 {
        font-size: 2rem;
      }
      
      h2 {
        font-size: 1.5rem;
      }
      
      .actions-toolbar {
        flex-direction: column;
        align-items: stretch;
      }
      
      .actions-toolbar .btn {
        justify-content: center;
      }
      
      .actions-inline {
        flex-direction: column;
        gap: 4px;
      }
      
      .actions-inline .btn {
        width: 100%;
        justify-content: center;
      }
      
      th, td {
        padding: 12px 16px;
        font-size: 0.8125rem;
      }
      
      .table-container {
        overflow-x: auto;
      }
      
      table {
        min-width: 600px;
      }
    }
  </style>
</head>
<body>
  <!-- Toast Container -->
  <div id="toast-container"></div>

  <!-- Sign-in -->
  <div id="signin-container">
    <div class="signin-icon">‚è±</div>
    <h1>Time Entry Tool</h1>
    <p class="subtitle">Track your time with ease and efficiency</p>
    <button id="signin-btn" class="btn btn-primary btn-lg">
      <span>Sign In with Microsoft</span>
    </button>
  </div>

  <!-- Main UI -->
  <div id="main-ui" class="hidden">
    <div class="section">
      <h2>
        <span>‚è±</span>
        Add Time Entry
      </h2>

      <div class="actions-toolbar">
        <button id="add-time-btn" class="btn btn-primary">
          <span>+</span>
          Add Time Entry
        </button>
        <button id="save-all-btn" class="btn btn-success">
          <span>üíæ</span>
          Save All
        </button>
        <button id="remove-all-btn" class="btn btn-danger">
          <span>üóë</span>
          Clear All
        </button>
      </div>

      <div class="table-container">
        <table aria-label="Time Entry table">
          <thead>
            <tr>
              <th class="required">Name</th>
              <th class="required">Date</th>
              <th class="required">Task</th>
              <th class="required">Hours</th>
              <th>Notes</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="entryBody"></tbody>
        </table>
      </div>
    </div>

    <div class="section">
      <h2>
        <span>üìä</span>
        Current Entries
      </h2>
      <div id="currentEntriesContainer">
        <div class="empty-state">
          <div class="empty-state-icon">üìù</div>
          <p>No time entries yet. Add your first entry above!</p>
        </div>
      </div>
    </div>
  </div>

<script>
/* ===========================================================
   Configuration
   =========================================================== */
const msalConfig = {
  auth: {
    clientId: "abe43417-4888-481d-8e63-c335313a3eac",
    authority: "https://login.microsoftonline.com/94f35210-3fa2-4689-8c39-06670b265f94",
    redirectUri: "https://tdpriest13.github.io/Time-Entry-Tool/"
  }
};
const msalInstance = new msal.PublicClientApplication(msalConfig);
const tokenRequest = { scopes: ["User.Read", "Sites.ReadWrite.All"] };

/* ===========================================================
   State
   =========================================================== */
let accessToken = null;
const entryGroups = {};
let currentlyEditingRow = null;

// Predefined list of names for the dropdown
const availableNames = [
  'John Smith',
  'Jane Doe', 
  'Mike Johnson',
  'Sarah Wilson',
  'David Brown',
  'Lisa Davis',
  'Chris Miller',
  'Amy Taylor'
];

// Predefined list of tasks for the dropdown
const availableTasks = [
  'Development',
  'Testing',
  'Code Review',
  'Documentation',
  'Meeting',
  'Planning',
  'Research',
  'Bug Fixing',
  'Training',
  'Support',
  'Deployment',
  'Analysis'
];

// Function to generate name options HTML
function generateNameOptions(selectedValue = '') {
  return availableNames.map(name => 
    `<option value="${escapeHtml(name)}" ${selectedValue === name ? 'selected' : ''}>${escapeHtml(name)}</option>`
  ).join('');
}

// Function to generate task options HTML
function generateTaskOptions(selectedValue = '') {
  return availableTasks.map(task => 
    `<option value="${escapeHtml(task)}" ${selectedValue === task ? 'selected' : ''}>${escapeHtml(task)}</option>`
  ).join('');
}

/* ===========================================================
   Utility Functions
   =========================================================== */
function escapeHtml(str){
  if (str == null) return '';
  return String(str)
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}

function showToast(message, type = 'success', duration = 3000) {
  const toast = document.createElement('div');
  toast.className = `toast toast-${type}`;
  toast.innerHTML = `
    <div style="display: flex; align-items: center; gap: 12px;">
      <span style="font-size: 18px;">
        ${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ö†Ô∏è'}
      </span>
      <span>${message}</span>
    </div>
  `;
  
  document.getElementById('toast-container').appendChild(toast);
  
  setTimeout(() => toast.classList.add('show'), 100);
  
  setTimeout(() => {
    toast.classList.remove('show');
    setTimeout(() => toast.remove(), 300);
  }, duration);
}

function setLoading(element, isLoading) {
  if (isLoading) {
    element.classList.add('loading');
    const spinner = document.createElement('span');
    spinner.className = 'spinner';
    element.insertBefore(spinner, element.firstChild);
  } else {
    element.classList.remove('loading');
    const spinner = element.querySelector('.spinner');
    if (spinner) spinner.remove();
  }
}

/* ===========================================================
   Authentication
   =========================================================== */
async function initializeApp() {
  if (typeof msal === 'undefined') {
    showAuthError();
    return;
  }

  try {
    // Check if user is already signed in
    const accounts = msalInstance.getAllAccounts();
    
    if (accounts.length > 0) {
      // User has an account, try to get token silently
      try {
        const tokenResp = await msalInstance.acquireTokenSilent({
          ...tokenRequest,
          account: accounts[0]
        });
        
        accessToken = tokenResp.accessToken;
        showMainUI();
        showToast('Welcome back! Automatically signed in.', 'success');
        addRow();
        await loadCurrentEntriesFromSharePoint();
        return;
      } catch (silentError) {
        // Silent token acquisition failed, but user still has account
        // Try interactive sign-in
        if (silentError.errorCode === 'consent_required' || 
            silentError.errorCode === 'interaction_required') {
          try {
            const tokenResp = await msalInstance.acquireTokenSilent({
              ...tokenRequest,
              account: accounts[0],
              forceRefresh: true
            });
            
            accessToken = tokenResp.accessToken;
            showMainUI();
            showToast('Welcome back! Automatically signed in.', 'success');
            addRow();
            await loadCurrentEntriesFromSharePoint();
            return;
          } catch (refreshError) {
            // If refresh also fails, show sign-in button
            console.log('Auto sign-in failed, showing manual sign-in option');
          }
        }
      }
    }
    
    // No account found or auto sign-in failed - show sign-in UI
    showSignInUI();
    
  } catch (error) {
    console.error('Initialization error:', error);
    showSignInUI();
  }
}

async function signIn(){
  const signInBtn = document.getElementById('signin-btn');
  
  if (typeof msal === 'undefined') {
    showAuthError();
    return;
  }
  
  setLoading(signInBtn, true);
  
  try {
    const loginResult = await msalInstance.loginPopup(tokenRequest);
    const tokenResp = await msalInstance.acquireTokenSilent({ 
      ...tokenRequest, 
      account: loginResult.account 
    });
    
    accessToken = tokenResp.accessToken;
    showMainUI();
    showToast('Successfully signed in!', 'success');
    addRow();
    await loadCurrentEntriesFromSharePoint();
    
  } catch(err){
    if (err && err.errorCode === "consent_required"){
      try {
        const popupResp = await msalInstance.acquireTokenPopup(tokenRequest);
        accessToken = popupResp.accessToken;
        showMainUI();
        showToast('Successfully signed in!', 'success');
        addRow();
        await loadCurrentEntriesFromSharePoint();
        return;
      } catch(e){
        showToast('Sign-in failed. Please try again.', 'error');
      }
    } else if (err.errorCode === 'popup_window_error' || err.errorMessage?.includes('popup')) {
      showToast('Popup blocked. Please allow popups for this site and try again.', 'error');
    } else {
      showToast(`Sign-in failed: ${err.errorMessage || 'Please check your connection and try again.'}`, 'error');
    }
  } finally {
    setLoading(signInBtn, false);
  }
}

function showSignInUI() {
  document.getElementById('signin-container').classList.remove('hidden');
  document.getElementById('main-ui').classList.add('hidden');
}

function showMainUI() {
  document.getElementById('signin-container').classList.add('hidden');
  document.getElementById('main-ui').classList.remove('hidden');
}

function showAuthError() {
  const signInBtn = document.getElementById('signin-btn');
  if (signInBtn) {
    signInBtn.innerHTML = '<span>‚ùå</span> Authentication library failed to load';
    signInBtn.disabled = true;
  }
  showToast('Authentication library failed to load. Please refresh the page.', 'error');
}

/* ===========================================================
   SharePoint Integration
   =========================================================== */
async function loadCurrentEntriesFromSharePoint(){
  try {
    const url = "https://graph.microsoft.com/v1.0/sites/netorgft5961137.sharepoint.com:/sites/NewBalance984:/lists/TimeEntries/items?expand=fields";
    const resp = await fetch(url, { method: 'GET', headers: { Authorization: `Bearer ${accessToken}` }});
    
    if (!resp.ok){
      const e = await resp.text();
      showToast('Failed to load existing entries', 'error');
      return;
    }
    
    const json = await resp.json();

    const container = document.getElementById('currentEntriesContainer');
    container.innerHTML = '';
    Object.keys(entryGroups).forEach(k => delete entryGroups[k]);

    if (!json.value || json.value.length === 0) {
      container.innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon">üìù</div>
          <p>No time entries yet. Add your first entry above!</p>
        </div>
      `;
      return;
    }

    json.value.forEach(item => {
      const f = item.fields || {};
      moveToCurrent({
        id: item.id,
        name: f.Title ?? f.Name ?? '',
        date: f.Date ?? '',
        task: f.Task ?? '',
        hours: Number(f.Hours) || 0,
        notes: f.Notes ?? ''
      });
    });

    showToast(`Loaded ${json.value.length} time entries`, 'success');
  } catch (err){
    showToast('Failed to load entries. Please refresh and try again.', 'error');
  }
}

/* ===========================================================
   Entry Management
   =========================================================== */
function addRow(data = {}){
  const table = document.getElementById('entryBody');
  const row = document.createElement('tr');
  row.style.animation = 'fadeInUp 0.3s ease-out';
  row.innerHTML = `
    <td>
      <select required>
        <option value="">Name</option>
        ${generateNameOptions(data.name)}
      </select>
    </td>
    <td><input type="date" value="${data.date||''}" required></td>
    <td>
      <select required>
        <option value="">Task</option>
        ${generateTaskOptions(data.task)}
      </select>
    </td>
    <td><input type="number" step="0.25" min="0" value="${(data.hours ?? 0)}" oninput="validateHours(this)" onfocus="this.select()" placeholder="0.00"></td>
    <td><input type="text" value="${escapeHtml(data.notes||'')}" placeholder="Optional notes"></td>
    <td class="actions-inline">
      <button class="btn btn-success btn-sm" onclick="saveRow(this)">
        <span>üíæ</span>
        Save
      </button>
      <button class="btn btn-secondary btn-sm" onclick="copyRow(this)">
        <span>üìã</span>
        Copy
      </button>
      <button class="btn btn-danger btn-sm" onclick="removeRow(this)">
        <span>üóë</span>
        Remove
      </button>
    </td>
  `;
  table.appendChild(row);
  const hoursInput = row.querySelector('input[type="number"]');
  if (hoursInput) validateHours(hoursInput);
}

function copyRow(btn){
  const row = btn.closest('tr');
  const nameSelect = row.querySelector('select');
  const taskSelect = row.querySelectorAll('select')[1]; // Second select is task
  const inputs = row.querySelectorAll('input');
  addRow({
    name: nameSelect.value,
    date: inputs[0].value,
    task: taskSelect.value,
    hours: inputs[1].value,
    notes: inputs[2].value
  });
  showToast('Row copied!', 'success', 2000);
}

function removeRow(btn){
  const row = btn.closest('tr');
  if (!confirm('Remove this entry?')) return;
  
  row.style.animation = 'fadeOutDown 0.3s ease-out';
  setTimeout(() => {
    row.remove();
    if (!document.querySelector('#entryBody tr')) addRow();
  }, 300);
}

function removeAll(){
  if (!confirm('Remove all unsaved entries? This cannot be undone.')) return;
  
  const tbody = document.getElementById('entryBody');
  Array.from(tbody.children).forEach((row, index) => {
    setTimeout(() => {
      row.style.animation = 'fadeOutDown 0.3s ease-out';
      setTimeout(() => row.remove(), 300);
    }, index * 50);
  });
  
  setTimeout(() => addRow(), 500);
  showToast('All entries cleared', 'warning');
}

function validateHours(input){
  const val = parseFloat(input.value);
  const isValid = val > 0 && val <= 24 && (val * 100) % 25 === 0;
  input.classList.toggle('invalid-hours', !isValid);
  
  let message = input.parentElement.querySelector('.validation-message');
  if (!isValid && val !== 0 && !isNaN(val)) {
    if (!message) {
      message = document.createElement('div');
      message.className = 'validation-message';
      input.parentElement.appendChild(message);
    }
    message.innerHTML = '<span>‚ö†Ô∏è</span> Hours must be 0.25-24.00 in 0.25 increments';
  } else if (message) {
    message.remove();
  }
}

async function saveRow(btn){
  const row = btn.closest('tr');
  if (!row || !validateRow(row)) return;

  setLoading(btn, true);
  btn.disabled = true;
  
  const nameSelect = row.querySelector('select');
  const taskSelect = row.querySelectorAll('select')[1]; // Second select is task
  const inputs = row.querySelectorAll('input');
  const data = {
    Title: nameSelect.value,
    Date: inputs[0].value,
    Task: taskSelect.value,
    Hours: parseFloat(inputs[1].value),
    Notes: inputs[2].value
  };

  try {
    const resp = await fetch(
      "https://graph.microsoft.com/v1.0/sites/netorgft5961137.sharepoint.com:/sites/NewBalance984:/lists/TimeEntries/items",
      {
        method: "POST",
        headers: {
          Authorization: `Bearer ${accessToken}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ fields: data })
      }
    );

    if (!resp.ok){
      const errBody = await resp.text();
      showToast('Failed to save entry. Please try again.', 'error');
      return;
    }

    const savedItem = await resp.json();
    
    row.style.animation = 'fadeOutUp 0.3s ease-out';
    setTimeout(() => {
      row.remove();
      if (!document.querySelector('#entryBody tr')) addRow();
    }, 300);

    setTimeout(() => {
      moveToCurrent({
        id: savedItem.id,
        name: data.Title,
        date: data.Date,
        task: data.Task,
        hours: data.Hours,
        notes: data.Notes
      });
      showToast('Time entry saved successfully!', 'success');
    }, 150);

  } catch (err){
    showToast('Failed to save entry. Please check your connection.', 'error');
  } finally {
    if (document.body.contains(btn)) {
      setLoading(btn, false);
      btn.disabled = false;
    }
  }
}

async function saveAll(){
  const rows = Array.from(document.querySelectorAll('#entryBody tr'));
  const validRows = rows.filter(r => validateRow(r));
  
  if (validRows.length === 0) {
    showToast('No valid entries to save', 'warning');
    return;
  }

  showToast(`Saving ${validRows.length} entries...`, 'success');
  
  for (let i = 0; i < validRows.length; i++) {
    const saveBtn = validRows[i].querySelector('button.btn-success');
    if (saveBtn) {
      await new Promise(resolve => {
        setTimeout(async () => {
          await saveRow(saveBtn);
          resolve();
        }, i * 200);
      });
    }
  }
}

function validateRow(row){
  let ok = true;
  const nameSelect = row.querySelector('select');
  const taskSelect = row.querySelectorAll('select')[1]; // Second select is task
  const inputs = row.querySelectorAll('input');
  
  // Validate name selection
  if (!nameSelect.value) {
    ok = false;
    nameSelect.style.animation = 'shake 0.3s ease-in-out';
  }
  
  // Validate task selection
  if (!taskSelect.value) {
    ok = false;
    taskSelect.style.animation = 'shake 0.3s ease-in-out';
  }
  
  // Validate other inputs
  inputs.forEach(inp => {
    if (inp.type === 'number') {
      validateHours(inp);
      if (inp.classList.contains('invalid-hours')) ok = false;
    }
    if (inp.hasAttribute('required') && !inp.value.trim()) {
      ok = false;
      inp.style.animation = 'shake 0.3s ease-in-out';
    }
  });
  
  if (!ok) {
    showToast('Please fill all required fields with valid values', 'error');
  }
  
  return ok;
}

/* ===========================================================
   Current Entries Display
   =========================================================== */
function moveToCurrent(data){
  const name = data.name || 'Unknown';
  const weekLabel = getWeekLabel(data.date || new Date().toISOString().slice(0,10));

  const container = document.getElementById('currentEntriesContainer');
  const emptyState = container.querySelector('.empty-state');
  if (emptyState) emptyState.remove();

  if (!entryGroups[name]) {
    const groupDiv = document.createElement('details');
    groupDiv.open = true;
    groupDiv.className = 'group-section';
    groupDiv.style.animation = 'fadeInUp 0.4s ease-out';
    groupDiv.innerHTML = `
      <summary>
        <span>üë§</span>
        <strong>${escapeHtml(name)}'s Entries</strong>
      </summary>
      <div class="group-weeks"></div>
    `;
    container.appendChild(groupDiv);
    entryGroups[name] = { container: groupDiv.querySelector('.group-weeks'), weeks: {} };
  }

  if (!entryGroups[name].weeks[weekLabel]) {
    const wrapper = document.createElement('div');
    wrapper.style.animation = 'fadeInUp 0.3s ease-out';
    wrapper.innerHTML = `
      <div class="table-container" style="margin-bottom: 24px;">
        <table>
          <thead>
            <tr>
              <th>Name</th>
              <th>Date</th>
              <th>Task</th>
              <th>Hours</th>
              <th>Notes</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr class="week-header">
              <td colspan="6">
                <span>üìÖ</span>
                ${escapeHtml(weekLabel)}
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    `;
    entryGroups[name].container.appendChild(wrapper);
    entryGroups[name].weeks[weekLabel] = wrapper.querySelector('tbody');
  }

  const tbody = entryGroups[name].weeks[weekLabel];

  const tr = document.createElement('tr');
  tr.dataset.spid = data.id || '';
  tr.style.animation = 'fadeInUp 0.3s ease-out';
  tr.innerHTML = `
    <td>${escapeHtml(data.name)}</td>
    <td>${escapeHtml(data.date)}</td>
    <td>${escapeHtml(data.task)}</td>
    <td>
      <span class="status-indicator status-success">
        ${(Number(data.hours) || 0).toFixed(2)}h
      </span>
    </td>
    <td>${escapeHtml(data.notes)}</td>
    <td class="actions-inline">
      <button class="btn btn-secondary btn-sm" onclick="enterEditMode(this)">
        <span>‚úèÔ∏è</span>
        Edit
      </button>
      <button class="btn btn-danger btn-sm" onclick="deleteEntry(this)">
        <span>üóë</span>
        Delete
      </button>
    </td>
  `;
  tbody.appendChild(tr);
  updateTotal(name, weekLabel);
}

/* ===========================================================
   Entry Management - Delete & Edit
   =========================================================== */
async function deleteEntry(btn){
  const tr = btn.closest('tr');
  const spid = tr.dataset.spid;
  const name = tr.closest('.group-weeks').parentElement.querySelector('summary strong').textContent.replace("'s Entries",'').trim();
  const weekLabel = tr.closest('tbody').querySelector('.week-header').textContent.replace('üìÖ ', '').trim();

  if (!confirm('Delete this entry? This cannot be undone.')) return;

  setLoading(btn, true);
  btn.disabled = true;

  if (spid){
    try {
      const url = `https://graph.microsoft.com/v1.0/sites/netorgft5961137.sharepoint.com:/sites/NewBalance984:/lists/TimeEntries/items/${spid}`;
      const resp = await fetch(url, { method: 'DELETE', headers: { Authorization: `Bearer ${accessToken}` }});
      if (!resp.ok){
        const body = await resp.text();
        showToast('Failed to delete entry. Please try again.', 'error');
        setLoading(btn, false);
        btn.disabled = false;
        return;
      }
    } catch (err){
      showToast('Failed to delete entry. Please check your connection.', 'error');
      setLoading(btn, false);
      btn.disabled = false;
      return;
    }
  }
  
  tr.style.animation = 'fadeOutDown 0.3s ease-out';
  setTimeout(() => {
    tr.remove();
    updateTotal(name, weekLabel);
    showToast('Entry deleted successfully', 'success');
  }, 300);
}

function enterEditMode(editBtn){
  const tr = editBtn.closest('tr');

  if (currentlyEditingRow && currentlyEditingRow !== tr){
    showToast('Please save or cancel the currently editing row first.', 'warning');
    return;
  }
  if (tr.classList.contains('editing')) return;

  currentlyEditingRow = tr;
  tr.classList.add('editing');

  const tds = tr.querySelectorAll('td');
  const orig = {
    name: tds[0].textContent,
    date: tds[1].textContent,
    task: tds[2].textContent,
    hours: tds[3].textContent.replace('h', '').trim(),
    notes: tds[4].textContent
  };
  tr.dataset.orig = JSON.stringify(orig);

  tds[0].innerHTML = `
    <select required>
      <option value="">Name</option>
      ${generateNameOptions(orig.name)}
    </select>
  `;
  tds[1].innerHTML = `<input type="date" value="${escapeHtml(orig.date)}" required>`;
  tds[2].innerHTML = `
    <select required>
      <option value="">Task</option>
      ${generateTaskOptions(orig.task)}
    </select>
  `;
  tds[3].innerHTML = `<input type="number" step="0.25" min="0" value="${parseFloat(orig.hours) || 0}" oninput="validateHours(this)" onfocus="this.select()" required>`;
  tds[4].innerHTML = `<input type="text" value="${escapeHtml(orig.notes)}">`;

  tds[5].innerHTML = `
    <button class="btn btn-success btn-sm" onclick="saveInlineEdit(this)">
      <span>üíæ</span>
      Save
    </button>
    <button class="btn btn-secondary btn-sm" onclick="cancelInlineEdit(this)">
      <span>‚ùå</span>
      Cancel
    </button>
  `;
}

async function saveInlineEdit(saveBtn){
  const tr = saveBtn.closest('tr');
  if (!tr || !tr.classList.contains('editing')) return;
  const nameSelect = tr.querySelector('select');
  const taskSelect = tr.querySelectorAll('select')[1]; // Second select is task
  const inputs = tr.querySelectorAll('input');
  
  if (!nameSelect.value || !taskSelect.value || !inputs[0].value || !inputs[1].value){
    showToast('Please fill Name, Date, Task, and Hours before saving.', 'error');
    return;
  }
  
  validateHours(inputs[1]); // Hours input is now the second input (index 1)
  if (inputs[1].classList.contains('invalid-hours')){
    showToast('Hours must be >0, ‚â§24, in 0.25 increments.', 'error');
    return;
  }

  const updated = {
    Title: nameSelect.value,
    Date: inputs[0].value,
    Task: taskSelect.value,
    Hours: parseFloat(inputs[1].value),
    Notes: inputs[2].value
  };

  const spid = tr.dataset.spid;
  if (!spid){
    showToast('This entry does not have a SharePoint ID and cannot be edited.', 'error');
    cancelInlineEdit(saveBtn);
    return;
  }

  setLoading(saveBtn, true);
  saveBtn.disabled = true;

  try {
    const url = `https://graph.microsoft.com/v1.0/sites/netorgft5961137.sharepoint.com:/sites/NewBalance984:/lists/TimeEntries/items/${spid}/fields`;
    const resp = await fetch(url, {
      method: 'PATCH',
      headers: {
        Authorization: `Bearer ${accessToken}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(updated)
    });

    if (!resp.ok){
      const errText = await resp.text();
      showToast('Failed to update entry. Please try again.', 'error');
      setLoading(saveBtn, false);
      saveBtn.disabled = false;
      return;
    }

    tr.classList.remove('editing');
    currentlyEditingRow = null;

    tr.children[0].textContent = updated.Title;
    tr.children[1].textContent = updated.Date;
    tr.children[2].textContent = updated.Task;
    tr.children[3].innerHTML = `
      <span class="status-indicator status-success">
        ${(Number(updated.Hours)||0).toFixed(2)}h
      </span>
    `;
    tr.children[4].textContent = updated.Notes;

    tr.children[5].innerHTML = `
      <button class="btn btn-secondary btn-sm" onclick="enterEditMode(this)">
        <span>‚úèÔ∏è</span>
        Edit
      </button>
      <button class="btn btn-danger btn-sm" onclick="deleteEntry(this)">
        <span>üóë</span>
        Delete
      </button>
    `;

    const name = updated.Title;
    const weekLabel = tr.closest('tbody').querySelector('.week-header').textContent.replace('üìÖ ', '').trim();
    updateTotal(name, weekLabel);
    
    showToast('Entry updated successfully!', 'success');

  } catch (err){
    showToast('Failed to update entry. Please check your connection.', 'error');
    setLoading(saveBtn, false);
    saveBtn.disabled = false;
  }
}

function cancelInlineEdit(cancelBtn){
  const tr = cancelBtn.closest('tr');
  if (!tr || !tr.classList.contains('editing')) return;
  const orig = JSON.parse(tr.dataset.orig || '{}');

  tr.children[0].textContent = orig.name;
  tr.children[1].textContent = orig.date;
  tr.children[2].textContent = orig.task;
  tr.children[3].innerHTML = `
    <span class="status-indicator status-success">
      ${orig.hours}h
    </span>
  `;
  tr.children[4].textContent = orig.notes;

  tr.children[5].innerHTML = `
    <button class="btn btn-secondary btn-sm" onclick="enterEditMode(this)">
      <span>‚úèÔ∏è</span>
      Edit
    </button>
    <button class="btn btn-danger btn-sm" onclick="deleteEntry(this)">
      <span>üóë</span>
      Delete
    </button>
  `;
  tr.classList.remove('editing');
  currentlyEditingRow = null;
}

/* ===========================================================
   Utility Functions
   =========================================================== */
function updateTotal(name, weekLabel){
  const tbody = entryGroups[name] && entryGroups[name].weeks[weekLabel];
  if (!tbody) return;
  const rows = Array.from(tbody.querySelectorAll('tr')).filter(r => !r.classList.contains('week-header') && !r.classList.contains('total-row'));
  let total = 0;
  rows.forEach(r => {
    const hourText = r.children[3].textContent || r.children[3].innerText || '';
    const val = parseFloat(hourText.replace('h', '').trim()) || 0;
    total += val;
  });

  let totalRow = tbody.querySelector('.total-row');
  if (!totalRow){
    totalRow = document.createElement('tr');
    totalRow.className = 'total-row';
    totalRow.innerHTML = `
      <td colspan="3">
        <strong>üìä Week Total:</strong>
      </td>
      <td>
        <span class="status-indicator ${total >= 40 ? 'status-success' : 'status-warning'}">
          ${total.toFixed(2)}h
        </span>
      </td>
      <td colspan="2"></td>
    `;
    tbody.appendChild(totalRow);
  } else {
    const indicator = totalRow.querySelector('.status-indicator');
    indicator.textContent = `${total.toFixed(2)}h`;
    indicator.className = `status-indicator ${total >= 40 ? 'status-success' : 'status-warning'}`;
  }
}

function getWeekLabel(dateStr){
  if (!dateStr) {
    const today = new Date();
    dateStr = today.toISOString().slice(0,10);
  }
  const d = new Date(dateStr);
  const start = new Date(d);
  start.setDate(d.getDate() - d.getDay());
  const end = new Date(start);
  end.setDate(start.getDate() + 6);
  
  const formatDate = (date) => {
    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
  };
  
  return `Week of ${formatDate(start)} - ${formatDate(end)}`;
}

/* ===========================================================
   Event Listeners
   =========================================================== */
document.addEventListener('DOMContentLoaded', async function() {
  // Initialize the app - this will auto-sign in if possible
  await initializeApp();
  
  // Set up event listeners
  const signInBtn = document.getElementById('signin-btn');
  if (signInBtn) {
    signInBtn.addEventListener('click', signIn);
  }
  
  const addTimeBtn = document.getElementById('add-time-btn');
  if (addTimeBtn) {
    addTimeBtn.addEventListener('click', () => addRow());
  }
  
  const saveAllBtn = document.getElementById('save-all-btn');
  if (saveAllBtn) {
    saveAllBtn.addEventListener('click', saveAll);
  }
  
  const removeAllBtn = document.getElementById('remove-all-btn');
  if (removeAllBtn) {
    removeAllBtn.addEventListener('click', removeAll);
  }
});
</script>

</body>
</html>
