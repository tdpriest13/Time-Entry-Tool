<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Time Entry Tool - Full CRUD</title>

  <!-- MSAL -->
  <script src="https://alcdn.msauth.net/browser/2.38.0/js/msal-browser.min.js"></script>

  <style>
    :root {
      --primary: #007bff;
      --primary-hover: #0056b3;
      --gray-bg: #f8f9fa;
      --border-color: #ced4da;
      --font: 'Segoe UI', Tahoma, sans-serif;
      --btn-gray: #6c757d;
      --btn-gray-hover: #5a6268;
      --btn-red: #dc3545;
      --btn-red-hover: #b02a37;
      --edit-bg: #fff3cd;
    }
    body { font-family: var(--font); background: var(--gray-bg); margin:0; padding:30px; }
    .section {
      background: white;
      padding: 24px;
      max-width: 1200px;
      margin: 0 auto 24px auto;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    h2 { font-size:22px; margin-bottom:12px; }
    .btn {
      border: none;
      border-radius: 6px;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      padding: 8px 14px;
      color: white;
      margin: 6px 6px 6px 0;
    }
    .btn-primary{ background:var(--primary); } .btn-primary:hover{ background:var(--primary-hover); }
    .btn-gray{ background:var(--btn-gray);} .btn-gray:hover{ background:var(--btn-gray-hover); }
    .btn-red{ background:var(--btn-red);} .btn-red:hover{ background:var(--btn-red-hover); }

    table{ width:100%; border-collapse:collapse; margin-bottom:10px; }
    th, td{ border:1px solid var(--border-color); padding:10px; text-align:left; vertical-align:middle; }
    th.required::after { content: " *"; color: var(--btn-red); }
    input, select { width:100%; padding:6px; box-sizing:border-box; }
    .invalid-hours { border:1px solid var(--btn-red); background:#ffe5e5; }
    .group-section { margin-bottom:20px; }
    .week-header td { background:#f1f1f1; font-weight:bold; }
    .total-row { background:#e6f0fa; font-weight:bold; }
    #signin-container { text-align:center; margin-top:100px; }
    .hidden { display:none; }
    tr.editing { background: var(--edit-bg) !important; }
    .actions-inline button { margin-right:6px; }
    /* small screens: allow controls to wrap */
    @media (max-width:720px){
      .actions-inline button{ display:block; margin-bottom:6px; }
    }
  </style>
</head>
<body>
  <!-- Sign-in -->
  <div id="signin-container">
    <h2>Welcome to the Time Entry Tool</h2>
    <button class="btn btn-primary" onclick="signIn()">Sign In</button>
  </div>

  <!-- Main UI -->
  <div id="main-ui" class="hidden">
    <div class="section">
      <h2>Time Entry</h2>

      <div id="entry-controls" style="margin-bottom:8px;">
        <button class="btn btn-primary" onclick="addRow()">Add Time</button>
      </div>

      <table aria-label="Time Entry table">
        <thead>
          <tr>
            <th class="required">Name</th>
            <th class="required">Date</th>
            <th class="required">Task</th>
            <th class="required">Hours</th>
            <th>Notes</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="entryBody"></tbody>
      </table>

      <div id="entry-footer">
        <button class="btn btn-primary" onclick="saveAll()">Save All</button>
        <button class="btn btn-red" onclick="removeAll()">Remove All</button>
      </div>
    </div>

    <div class="section">
      <h2>Current Entries</h2>
      <div id="currentEntriesContainer"></div>
    </div>
  </div>

<script>
/* ===========================================================
   Configuration - update these to match your Azure + SP setup
   =========================================================== */
const msalConfig = {
  auth: {
    clientId: "abe43417-4888-481d-8e63-c335313a3eac",
    authority: "https://login.microsoftonline.com/94f35210-3fa2-4689-8c39-06670b265f94",
    redirectUri: "https://tdpriest13.github.io/Time-Entry-Tool/"
  }
};
const msalInstance = new msal.PublicClientApplication(msalConfig);
const tokenRequest = { scopes: ["User.Read", "Sites.ReadWrite.All"] };

/* ===========================================================
   State
   =========================================================== */
let accessToken = null;
const entryGroups = {}; // grouping for UI (name -> weeks)
let currentlyEditingRow = null; // only one row may be edited at a time

/* ===========================================================
   Sign in + load data
   =========================================================== */
async function signIn(){
  try {
    const loginResult = await msalInstance.loginPopup(tokenRequest);
    const tokenResp = await msalInstance.acquireTokenSilent({ ...tokenRequest, account: loginResult.account });
    accessToken = tokenResp.accessToken;

    document.getElementById('signin-container').classList.add('hidden');
    document.getElementById('main-ui').classList.remove('hidden');

    addRow(); // show one blank row
    await loadCurrentEntriesFromSharePoint();
  } catch(err){
    // If acquireTokenSilent fails (consent or other), attempt interactive for required scopes
    if (err && err.errorCode === "consent_required"){
      try {
        const popupResp = await msalInstance.acquireTokenPopup(tokenRequest);
        accessToken = popupResp.accessToken;
        document.getElementById('signin-container').classList.add('hidden');
        document.getElementById('main-ui').classList.remove('hidden');
        addRow();
        await loadCurrentEntriesFromSharePoint();
        return;
      } catch(e){
        console.error('Interactive consent failed', e);
      }
    }
    console.error('Sign-in error', err);
    alert('Sign-in failed (see console).');
  }
}

/* ===========================================================
   Read from SharePoint (Graph)
   =========================================================== */
async function loadCurrentEntriesFromSharePoint(){
  try {
    const url = "https://graph.microsoft.com/v1.0/sites/netorgft5961137.sharepoint.com:/sites/NewBalance984:/lists/TimeEntries/items?expand=fields";
    const resp = await fetch(url, { method: 'GET', headers: { Authorization: `Bearer ${accessToken}` }});
    if (!resp.ok){
      const e = await resp.text();
      console.error('Failed to fetch entries', resp.status, e);
      return;
    }
    const json = await resp.json();

    // Clear old UI & cache
    const container = document.getElementById('currentEntriesContainer');
    container.innerHTML = '';
    Object.keys(entryGroups).forEach(k => delete entryGroups[k]);

    // Render each item
    (json.value || []).forEach(item => {
      const f = item.fields || {};
      // support Title OR Name (Title is typical internal name)
      moveToCurrent({
        id: item.id,
        name: f.Title ?? f.Name ?? '',
        date: f.Date ?? '',
        task: f.Task ?? '',
        hours: Number(f.Hours) || 0,
        notes: f.Notes ?? ''
      });
    });
  } catch (err){
    console.error('loadCurrentEntriesFromSharePoint error', err);
  }
}

/* ===========================================================
   Top-row: add/copy/remove/save logic for Time Entry input rows
   =========================================================== */
function addRow(data = {}){
  const table = document.getElementById('entryBody');
  const row = document.createElement('tr');
  row.innerHTML = `
    <td><input type="text" value="${escapeHtml(data.name||'')}" required></td>
    <td><input type="date" value="${data.date||''}" required></td>
    <td><input type="text" value="${escapeHtml(data.task||'')}" required></td>
    <td><input type="number" step="0.25" min="0" value="${(data.hours ?? 0)}" oninput="validateHours(this)"></td>
    <td><input type="text" value="${escapeHtml(data.notes||'')}"></td>
    <td class="actions-inline">
      <button class="btn btn-primary btn-sm" onclick="saveRow(this)">Save</button>
      <button class="btn btn-gray btn-sm" onclick="copyRow(this)">Copy</button>
      <button class="btn btn-red btn-sm" onclick="removeRow(this)">Remove</button>
    </td>
  `;
  table.appendChild(row);
  // validate hours initial state
  const hoursInput = row.querySelector('input[type="number"]');
  if (hoursInput) validateHours(hoursInput);
}

function copyRow(btn){
  const row = btn.closest('tr');
  const inputs = row.querySelectorAll('input');
  addRow({
    name: inputs[0].value,
    date: inputs[1].value,
    task: inputs[2].value,
    hours: inputs[3].value,
    notes: inputs[4].value
  });
}

function removeRow(btn){
  const row = btn.closest('tr');
  row.remove();
  if (!document.querySelector('#entryBody tr')) addRow();
}

function removeAll(){
  document.getElementById('entryBody').innerHTML = '';
  addRow();
}

function validateHours(input){
  const val = parseFloat(input.value);
  input.classList.toggle('invalid-hours', !(val > 0 && val <= 24 && (val * 100) % 25 === 0));
}

/* ===========================================================
   Save single row -> POST to SharePoint, then move into Current Entries (with id)
   Also prevents double-posts and surfaces Graph error messages
   =========================================================== */
async function saveRow(btn){
  const row = btn.closest('tr');
  if (!row || !validateRow(row)) return;

  // disable button to prevent double-clicks
  btn.disabled = true;
  const inputs = row.querySelectorAll('input');
  const data = {
    Title: inputs[0].value, // use Title for the list's primary text column
    Date: inputs[1].value,
    Task: inputs[2].value,
    Hours: parseFloat(inputs[3].value),
    Notes: inputs[4].value
  };

  try {
    const resp = await fetch(
      "https://graph.microsoft.com/v1.0/sites/netorgft5961137.sharepoint.com:/sites/NewBalance984:/lists/TimeEntries/items",
      {
        method: "POST",
        headers: {
          Authorization: `Bearer ${accessToken}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ fields: data })
      }
    );

    if (!resp.ok){
      const errBody = await resp.text();
      console.error('SharePoint POST error', resp.status, errBody);
      alert('Save failed (see console).');
      btn.disabled = false;
      return;
    }

    const savedItem = await resp.json();
    // remove input row
    row.remove();
    if (!document.querySelector('#entryBody tr')) addRow();

    // move to current entries with the returned id (so delete/edit works immediately)
    moveToCurrent({
      id: savedItem.id,
      name: data.Title,
      date: data.Date,
      task: data.Task,
      hours: data.Hours,
      notes: data.Notes
    });

  } catch (err){
    console.error('saveRow exception', err);
    alert('Save failed (see console).');
  } finally {
    // ensure button re-enabled if row still exists
    if (document.body.contains(btn)) btn.disabled = false;
  }
}

/* Save all: iterate each input-row and call saveRow on its Save button.
   We skip invalid rows (validateRow handles it).
*/
function saveAll(){
  const rows = Array.from(document.querySelectorAll('#entryBody tr'));
  rows.forEach(r => {
    const saveBtn = r.querySelector('button.btn-primary');
    if (saveBtn && validateRow(r)) saveRow(saveBtn);
  });
}

/* validate input row */
function validateRow(row){
  let ok = true;
  row.querySelectorAll('input').forEach(inp => {
    if (inp.type === 'number') validateHours(inp);
    if (!inp.checkValidity()) ok = false;
  });
  return ok;
}

/* ===========================================================
   Current Entries rendering & grouping logic
   =========================================================== */
function moveToCurrent(data){
  // data: { id, name, date, task, hours, notes }
  const name = data.name || 'Unknown';
  const weekLabel = getWeekLabel(data.date || new Date().toISOString().slice(0,10));

  // create group container for name if not exists
  if (!entryGroups[name]) {
    const groupDiv = document.createElement('details');
    groupDiv.open = true;
    groupDiv.className = 'group-section';
    groupDiv.innerHTML = `<summary><strong>${escapeHtml(name)}'s Entries</strong></summary><div class="group-weeks"></div>`;
    document.getElementById('currentEntriesContainer').appendChild(groupDiv);
    entryGroups[name] = { container: groupDiv.querySelector('.group-weeks'), weeks: {} };
  }

  // ensure week table present
  if (!entryGroups[name].weeks[weekLabel]) {
    const wrapper = document.createElement('div');
    wrapper.innerHTML = `
      <table>
        <thead><tr><th>Name</th><th>Date</th><th>Task</th><th>Hours</th><th>Notes</th><th>Actions</th></tr></thead>
        <tbody><tr class="week-header"><td colspan="6">${escapeHtml(weekLabel)}</td></tr></tbody>
      </table>
    `;
    entryGroups[name].container.appendChild(wrapper);
    entryGroups[name].weeks[weekLabel] = wrapper.querySelector('tbody');
  }

  const tbody = entryGroups[name].weeks[weekLabel];

  // append row (store sp id on data-spid)
  const tr = document.createElement('tr');
  tr.dataset.spid = data.id || '';
  tr.innerHTML = `
    <td>${escapeHtml(data.name)}</td>
    <td>${escapeHtml(data.date)}</td>
    <td>${escapeHtml(data.task)}</td>
    <td>${(Number(data.hours) || 0).toFixed(2)}</td>
    <td>${escapeHtml(data.notes)}</td>
    <td class="actions-inline">
      <button class="btn btn-gray btn-sm" onclick="enterEditMode(this)">Edit</button>
      <button class="btn btn-red btn-sm" onclick="deleteEntry(this)">Delete</button>
    </td>
  `;
  tbody.appendChild(tr);
  updateTotal(name, weekLabel);
}

/* ===========================================================
   Delete from UI & SharePoint
   =========================================================== */
async function deleteEntry(btn){
  const tr = btn.closest('tr');
  const spid = tr.dataset.spid;
  const name = tr.closest('.group-weeks').parentElement.querySelector('summary').textContent.replace("'s Entries",'').trim();
  const weekLabel = tr.closest('tbody').querySelector('.week-header').textContent;

  if (!confirm('Delete this entry?')) return;

  // If spid exists, delete in SharePoint first
  if (spid){
    try {
      const url = `https://graph.microsoft.com/v1.0/sites/netorgft5961137.sharepoint.com:/sites/NewBalance984:/lists/TimeEntries/items/${spid}`;
      const resp = await fetch(url, { method: 'DELETE', headers: { Authorization: `Bearer ${accessToken}` }});
      if (!resp.ok){
        const body = await resp.text();
        console.error('DELETE error', resp.status, body);
        alert('Delete failed (see console).');
        return;
      }
    } catch (err){
      console.error('deleteEntry exception', err);
      alert('Delete failed (see console).');
      return;
    }
  }
  // remove from UI and update totals
  tr.remove();
  // updateTotal expects name and weekLabel
  // Extract plain weekLabel text (we used format "This Week (yyyy-mm-dd–yyyy-mm-dd)")
  updateTotal(name, weekLabel);
}

/* ===========================================================
   Inline edit logic (single-row only)
   =========================================================== */
function enterEditMode(editBtn){
  const tr = editBtn.closest('tr');

  if (currentlyEditingRow && currentlyEditingRow !== tr){
    alert('Please Save or Cancel the currently editing row first.');
    return;
  }
  if (tr.classList.contains('editing')) return; // already in edit mode

  currentlyEditingRow = tr;
  tr.classList.add('editing');

  // Save current cells so we can cancel
  const tds = tr.querySelectorAll('td');
  // original values
  const orig = {
    name: tds[0].textContent,
    date: tds[1].textContent,
    task: tds[2].textContent,
    hours: tds[3].textContent,
    notes: tds[4].textContent
  };
  tr.dataset.orig = JSON.stringify(orig);

  // Replace cells 0..4 with inputs
  tds[0].innerHTML = `<input type="text" value="${escapeHtml(orig.name)}">`;
  tds[1].innerHTML = `<input type="date" value="${escapeHtml(orig.date)}">`;
  tds[2].innerHTML = `<input type="text" value="${escapeHtml(orig.task)}">`;
  tds[3].innerHTML = `<input type="number" step="0.25" min="0" value="${parseFloat(orig.hours) || 0}" oninput="validateHours(this)">`;
  tds[4].innerHTML = `<input type="text" value="${escapeHtml(orig.notes)}">`;

  // Replace actions with Save & Cancel
  tds[5].innerHTML = `
    <button class="btn btn-primary btn-sm" onclick="saveInlineEdit(this)">Save</button>
    <button class="btn btn-gray btn-sm" onclick="cancelInlineEdit(this)">Cancel</button>
  `;
}

async function saveInlineEdit(saveBtn){
  const tr = saveBtn.closest('tr');
  if (!tr || !tr.classList.contains('editing')) return;
  const inputs = tr.querySelectorAll('input');
  // validation: make sure required fields are present
  if (!inputs[0].value || !inputs[1].value || !inputs[2].value || !inputs[3].value){
    alert('Please fill Name, Date, Task, and Hours before saving.');
    return;
  }
  validateHours(inputs[3]);
  if (inputs[3].classList.contains('invalid-hours')){
    alert('Hours must be >0, <=24, in 0.25 increments.');
    return;
  }

  // Collect updated values
  const updated = {
    Title: inputs[0].value,
    Date: inputs[1].value,
    Task: inputs[2].value,
    Hours: parseFloat(inputs[3].value),
    Notes: inputs[4].value
  };

  const spid = tr.dataset.spid;
  // If there's no spid, can't edit (shouldn't happen since loaded entries have ids)
  if (!spid){
    alert('This entry does not have a SharePoint id and cannot be edited inline.');
    cancelInlineEdit(saveBtn);
    return;
  }

  // Disable save button to prevent double-click
  saveBtn.disabled = true;

  try {
    const url = `https://graph.microsoft.com/v1.0/sites/netorgft5961137.sharepoint.com:/sites/NewBalance984:/lists/TimeEntries/items/${spid}/fields`;
    const resp = await fetch(url, {
      method: 'PATCH',
      headers: {
        Authorization: `Bearer ${accessToken}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(updated)
    });

    if (!resp.ok){
      const errText = await resp.text();
      console.error('PATCH error', resp.status, errText);
      alert('Update failed (see console).');
      saveBtn.disabled = false;
      return;
    }

    // success: update UI cells and end edit mode
    tr.classList.remove('editing');
    currentlyEditingRow = null;

    // Update row display (hours formatted)
    tr.children[0].textContent = updated.Title;
    tr.children[1].textContent = updated.Date;
    tr.children[2].textContent = updated.Task;
    tr.children[3].textContent = (Number(updated.Hours)||0).toFixed(2);
    tr.children[4].textContent = updated.Notes;

    // restore actions
    tr.children[5].innerHTML = `
      <button class="btn btn-gray btn-sm" onclick="enterEditMode(this)">Edit</button>
      <button class="btn btn-red btn-sm" onclick="deleteEntry(this)">Delete</button>
    `;

    // Update totals for the week
    const name = updated.Title;
    const weekLabel = tr.closest('tbody').querySelector('.week-header').textContent;
    updateTotal(name, weekLabel);

  } catch (err){
    console.error('saveInlineEdit exception', err);
    alert('Update failed (see console).');
    saveBtn.disabled = false;
  }
}

function cancelInlineEdit(cancelBtn){
  const tr = cancelBtn.closest('tr');
  if (!tr || !tr.classList.contains('editing')) return;
  const orig = JSON.parse(tr.dataset.orig || '{}');

  // restore cells
  tr.children[0].textContent = orig.name;
  tr.children[1].textContent = orig.date;
  tr.children[2].textContent = orig.task;
  tr.children[3].textContent = orig.hours;
  tr.children[4].textContent = orig.notes;

  // restore actions
  tr.children[5].innerHTML = `
    <button class="btn btn-gray btn-sm" onclick="enterEditMode(this)">Edit</button>
    <button class="btn btn-red btn-sm" onclick="deleteEntry(this)">Delete</button>
  `;
  tr.classList.remove('editing');
  currentlyEditingRow = null;
}

/* ===========================================================
   Totals and helpers
   =========================================================== */
function updateTotal(name, weekLabel){
  const tbody = entryGroups[name] && entryGroups[name].weeks[weekLabel];
  if (!tbody) return;
  const rows = Array.from(tbody.querySelectorAll('tr')).filter(r => !r.classList.contains('week-header') && !r.classList.contains('total-row'));
  let total = 0;
  rows.forEach(r => {
    const val = parseFloat(r.children[3].textContent) || 0;
    total += val;
  });

  let totalRow = tbody.querySelector('.total-row');
  if (!totalRow){
    totalRow = document.createElement('tr');
    totalRow.className = 'total-row';
    totalRow.innerHTML = `<td colspan="3">Total:</td><td>${total.toFixed(2)}</td><td colspan="2"></td>`;
    tbody.appendChild(totalRow);
  } else {
    // totalRow structure: <td colspan=3>Total:</td><td>value</td>...
    totalRow.children[1].textContent = total.toFixed(2);
  }
}

function getWeekLabel(dateStr){
  if (!dateStr) {
    const today = new Date();
    dateStr = today.toISOString().slice(0,10);
  }
  const d = new Date(dateStr);
  const start = new Date(d);
  start.setDate(d.getDate() - d.getDay());
  const end = new Date(start);
  end.setDate(start.getDate() + 6);
  return `This Week (${start.toISOString().slice(0,10)}–${end.toISOString().slice(0,10)})`;
}

/* small escaping helper for safety in innerHTML creation */
function escapeHtml(str){
  if (str == null) return '';
  return String(str)
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}

</script>
</body>
</html>
